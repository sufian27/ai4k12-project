{% extends "base.html" %}

{% block content %}
<div class="row">
	<div class="col-md-8 col-xs-8 col-sm-8 col-lg-8">
		<div class="row">
			<div class="col compare-block selected-block" id="block0">
				<!-- <div class="compare-canvas" id = "canvas0" ondragover = 'allowDrop(event)' ondrop = 'dropChild(event)' ></div> -->
				<div class="compare-canvas" id = "canvas0" ></div>
				<div class="compare-index"></div>				
			</div>
			<button type="button" class="btn btn-primary add-btn float-left">+</button>			
		</div>
	</div>
	<div id="face-browser" class="col-md-4 col-xs-4 col-sm-4 col-lg-4" style="height: 420px; overflow: scroll;"></div>
</div>
{% endblock %}

{% block script %}
<script src="{{ url_for('static', filename = 'js/chernoffface.js') }}"></script>
<script src="{{ url_for('static', filename = 'js/dragdrop_tag.js') }}"></script>
<script>
	// alert("inner script");
	function readpara (para) {
		return para;
	}
	var example_id = readpara( {{ example | safe }} );
	var user_id = readpara( {{ g.user.id | safe }} );
	var dataset_face = readpara( {{ dataset_face | safe }} );
	var json_object = readpara( {{ json_data | tojson | safe }} );
	var json_dataset = JSON.parse(json_object).records;

	var getLocalData = localStorage.getItem('mappingRule');
	var json_mapping = JSON.parse(getLocalData);
	var datapoint_face = json_dataset[0]; //default datapoint for chernoffface.js
	// var variables = Object.keys(json_dataset[0]);

	var current_id = 0;
	$(document).on("click", "button.close" , function() {
    	var id = $(this).parent(".badge")
    		.clone()
    		.children() //select all the children
    		.remove()   //remove all the children
    		.end()  //again go back to selected element
    		.text();
    	var data_id = parseInt(id) - 1;
    	
    	if (!$("#drag" + data_id).hasClass('hidden')) {
    		var image = $("#drag" + data_id);
	    	$("#drag" + data_id).remove();
	    	image.attr("width", 35);
	    	image.css("opacity", 1);
	    	$("#wrap" + data_id).append(image);
	    	$("#wrap" + data_id).css('opacity', 1);
	    	$("#drag" + data_id).removeClass("overlay");
	    	$("#drag" + data_id).css('z-index', 0);
	    	var canvas_id = $(this).parent(".badge").parent(".compare-index").siblings(".compare-canvas").attr("id");
	    	var x = $("#" + canvas_id).children().length;
	    	if (x!=0) {
	    		$("#" + canvas_id).children("img").css('opacity', 1/x);
	    	}
	    	$(this).parent(".badge").remove();
    	}
	});

	$(document).on('click', 'button.close-btn', function() {
    	var id = $(this).parent(".badge")
    		.clone()
    		.children() //select all the children
    		.remove()   //remove all the children
    		.end()  //again go back to selected element
    		.text();
    	current_id = parseInt(id) - 1;
    	if (!$("#overlay" + current_id).hasClass('hidden')) {
			var block_id = $( '#overlay' + current_id ).parent('.compare-canvas').attr('id').substr(6);
			$( '#overlay' + current_id ).remove();
			$( '#tag' + current_id ).remove();
			$( '#wrap' + current_id ).removeClass('gone');
	        if ( $('#canvas' + block_id).children('span').length == 1 ) {
	        	$('#canvas' + block_id).children('span').children('svg').attr('opacity', 1);
	        } else if ( $('#canvas' + block_id).children('span').length == 0 && ($('.compare-block').length > 1)) {
	        	if ($('#block' + block_id).hasClass('selected-block')) {
	        		$('#block' + block_id).remove();
	        		var new_selected = $('.compare-block').length - 1;
	        		$('.compare-block').eq(new_selected).addClass('selected-block');
	        	} else {
	        		$('#block' + block_id).remove();
	        	}

	        }
    	}
	
	});

	$(document).on('click', ".conbox", function() {
		var svg_id = $(this).children('svg').attr('id');
        current_id = svg_id.substr(5);
		if ($(this).hasClass('gone')) {
			// d3.select('#overlay' + current_id + ' svg').remove();
			$( '#overlay' + current_id ).remove();
			$( '#tag' + current_id ).remove();
			$(this).removeClass('gone');
	        if ($('.selected-block .compare-canvas').children('span').length == 1) {
	        	$('.selected-block .compare-canvas span').children('svg').attr('opacity', 1);
	        }			
		} else {
	        datapoint_face = dataset_face[current_id];
	        $('.selected-block .compare-canvas').append($('<span id = "overlay' + current_id + '"></span>'))
	        $('#overlay' + current_id).addClass('overlay');
	        d3.select('#overlay' + current_id)
	        	.call(chernoffFace())
	        // $('.selected-block .compare-canvas').children('svg')
	        // $('.selected-block .compare-canvas').children('svg').addClass('overlay');
	        if ($('.selected-block .compare-canvas').children('span').length > 1) {
	        	$('.selected-block .compare-canvas span').children('svg').attr('opacity', 0.5);
	        }
	        var elem = $('.selected-block .compare-index');
	        addTag(elem, current_id);
	        $(this).addClass('gone');
	        console.log($('.selected-block .compare-canvas').children('span').length);     
	    }
	});

	$(".add-btn").click(function () {
		var current_num = $('.compare-block').length;
		$('.compare-block').removeClass('selected-block');
		var compare_template = $('.compare-block').eq(0).clone();
		var block_id = $('.compare-block').length;
		compare_template.attr('id', 'block' + block_id);
		compare_template.addClass('selected-block');
		compare_template.children(".compare-canvas").children().remove();
		compare_template.children(".compare-index").children().remove();
		compare_template.children(".compare-canvas").attr('id', 'canvas' + current_num);
		// $('.compare-row').append(compare_template);
		$(this).before(compare_template);
	});

</script>
<script src="{{ url_for('static', filename = 'js/face_browser.js') }}"></script>
<script src="{{ url_for('static', filename = 'js/center_face.js') }}"></script>
{% endblock %}